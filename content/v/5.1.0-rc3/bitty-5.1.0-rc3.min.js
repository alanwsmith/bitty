const t=[5,1,0],e=`bitty-${t[0]}-${t[1]}`,n=new CSSStyleSheet;function a(){return self.crypto.randomUUID()}n.replaceSync(`${e} { display: block; }`),document.adoptedStyleSheets.push(n);class i extends Error{constructor(t){super(),Error.captureStackTrace&&Error.captureStackTrace(this,i),this.name="BittyError";for(let[e,n]of Object.entries(t))this[e]=n}}class s extends HTMLElement{constructor(){super(),this.config={listeners:["click","input"],license:"MIT",version:t},this.receivers=[]}async connectedCallback(){this.dataset.bittyid=a(),await this.makeConnection(),this.conn&&(this.conn.api=this,this.handleCatchBridge=this.handleCatch.bind(this),this.handleEventBridge=this.handleEvent.bind(this),this.addEventListeners(),await this.callBittyInit(),this.runElementDataInits(),this.runSendFromComponent(),await this.callBittyReady())}addEventListeners(){this.dataset.listeners&&(this.config.listeners=this.dataset.listeners.split(/\s+/m).map(t=>t.trim())),this.config.listeners.forEach(t=>{window.addEventListener(t,t=>{t.target&&t.target.nodeName&&t.target.nodeName.toLowerCase()!==e&&t.target.dataset&&(t.target.dataset.send||t.target.dataset.s)?this.handleEventBridge.call(this,t):this.handleCatchBridge.call(this,t)})})}addReceiver(t,e){this.conn[t]&&this.receivers.push({key:t,f:async n=>{await this.conn[t](n,e)}})}async callBittyInit(){"function"==typeof this.conn.bittyInit&&("AsyncFunction"===this.conn.bittyInit[Symbol.toStringTag]?await this.conn.bittyInit():this.conn.bittyInit())}async callBittyReady(){"function"==typeof this.conn.bittyReady&&("AsyncFunction"===this.conn.bittyReady[Symbol.toStringTag]?await this.conn.bittyReady():this.conn.bittyReady())}connectedMoveCallback(){}forward(t,e){t.bitty={forward:e},this.handleEvent(t)}trigger(t){this.handleEvent({type:"bittytrigger",bitty:{forward:t}})}async getElement(t,e=[],n={}){let a=await this.getTXT(t,e,n,"getElement");if(a.error)return a;{const t=document.createElement("template");t.innerHTML=a.value;return{value:t.content.cloneNode(!0).firstChild}}}async getHTML(t,e=[],n={}){const a=await this.getTXT(t,e,n,"getHTML");if(a.error)return a;{const t=document.createElement("template");t.innerHTML=a.value;return{value:t.content.cloneNode(!0)}}}async getJSON(t,e=[],n={}){const a=await this.getTXT(t,e,n,"getJSON");if(a.error)return a;try{const t=JSON.parse(a.value);return{value:t}}catch(t){return{error:new i({type:"parsing"})}}}async getSVG(t,e=[],n={}){const a=await this.getTXT(t,e,n,"getSVG");if(a.error)return a;{const t=document.createElement("template");t.innerHTML=a.value;return{value:t.content.cloneNode(!0).querySelector("svg")}}}async getTXT(t,e=[],n={},a="getTXT"){let s=await fetch(t,n);try{if(s.ok){let t=await s.text();e.forEach(e=>{const n=typeof e[1],a=Object.prototype.toString.call(e[1]);if("object"===n&&"[object Array]"===a){const n=e[1].map(t=>{const e=typeof t,n=Object.prototype.toString.call(t);return"object"===e&&"[object DocumentFragment]"===n?[...t.children].map(t=>t.outerHTML).join(""):"object"===e?t.outerHTML:t}).join("");t=t.replaceAll(e[0],n)}else if("object"===n&&"[object DocumentFragment]"===a){const n=[];[...e[1].children].forEach(t=>{n.push(t.outerHTML)}),t=t.replaceAll(e[0],n.join(""))}else t="object"==typeof e[1]?t.replaceAll(e[0],e[1].outerHTML):t.replaceAll(e[0],e[1])});return{value:t}}throw new i({type:"fetching",message:`${a}() returned ${s.status} [${s.statusText}] in:\n${a}(${s.url}, ${JSON.stringify(e)}, ${JSON.stringify(n)})`,statusText:s.statusText,status:s.status,url:s.url,incomingMethod:a,subs:e,options:n})}catch(t){return console.error(`BittyError: ${t.message}`),{error:t}}}async handleCatch(t){"function"==typeof this.conn.bittyCatch&&await this.conn.bittyCatch(t)}async handleEvent(t){let e="";t.bitty&&t.bitty.forward?(e=t.bitty.forward,delete t.bitty.forward):(t.target.dataset.send&&(e+=`${t.target.dataset.send} `),t.target.dataset.s&&(e+=`${t.target.dataset.s} `)),await this.processSignals(t,e)}async loadCSS(t,e,n){const a=await this.getTXT(t,e,n,"loadCSS");if(a.error)return a;{const t=new CSSStyleSheet;t.replaceSync(a.value),document.adoptedStyleSheets.push(t);return{value:a.value}}}loadReceivers(){this.receivers=[],this.querySelectorAll("[data-receive]").forEach(t=>{t.dataset.receive.split(/\s+/m).map(t=>t.trim()).forEach(e=>{this.addReceiver(e,t)})})}async makeConnection(){try{if(this.dataset.connect){const t=this.dataset.connect.split(/\s+/m).map(t=>t.trim());if(void 0!==window[t[0]])this.conn=new window[t[0]];else{const e=await import(t[0]);void 0===t[1]?this.conn=new e.default:this.conn=new e[t[1]]}}else window.BittyClass?this.conn=new window.BittyClass:console.error(`${e} error: No class to connect to.`)}catch(t){console.error(`${e} error: ${t} - ${this.dataset.connect}`)}}makeElement(t,e=[]){return this.makeHTML(t,e).firstChild}makeHTML(t,e=[]){const n=document.createElement("template");return n.innerHTML=this.makeTXT(t,e).trim(),n.content.cloneNode(!0)}makeTXT(t,e=[]){return e.forEach(e=>{const n=typeof e[1],a=Object.prototype.toString.call(e[1]);if("object"===n&&"[object Array]"===a){const n=e[1].map(t=>{const e=typeof t,n=Object.prototype.toString.call(t);return"object"===e&&"[object DocumentFragment]"===n?[...t.children].map(t=>t.outerHTML).join(""):"object"===e?t.outerHTML:t}).join("");t=t.replaceAll(e[0],n)}else if("object"===n&&"[object DocumentFragment]"===a){const n=[];[...e[1].children].forEach(t=>{n.push(t.outerHTML)}),t=t.replaceAll(e[0],n.join(""))}else t="object"==typeof e[1]?t.replaceAll(e[0],e[1].outerHTML):t.replaceAll(e[0],e[1])}),t}match(t,e,n="bittyid"){return void 0!==t.target.dataset[n]&&void 0!==e.dataset[n]&&t.target.dataset[n]===e.dataset[n]}async processSignals(t,e){const n=e.split(/\s+/m).map(t=>t.trim());for(let e of n){this.setIds(),this.loadReceivers();const n=e.split(":"),a=1===n.length?n[0]:n[1],i="await"===(n.length>=2?n[0]:"");let s=0;for(const e of this.receivers)e.key===a&&(s+=1,!0===i?await e.f(t):e.f(t));0===s&&this.conn[a]&&(!0===i?await this.conn[a](t,null):this.conn[a](t,null))}}runElementDataInits(){this.querySelectorAll("[data-init]").forEach(t=>{const e=t.dataset.init.split(/\s/);this.setIds(),e.forEach(e=>{this.conn[e]&&this.conn[e]({type:"bittydatainit"},t)})})}runSendFromComponent(){this.dataset.send&&this.handleEvent({type:"bittytagdatasend",target:this}),this.dataset.s&&this.handleEvent({type:"bittytagdatasend",target:this})}setProp(t,e){document.documentElement.style.setProperty(t,e)}setIds(){this.querySelectorAll("[data-init]:not([data-bittyid])").forEach(t=>{t.dataset.bittyid=a()}),this.querySelectorAll("[data-receive]:not([data-bittyid])").forEach(t=>{t.dataset.bittyid=a()}),this.querySelectorAll("[data-send]:not([data-bittyid])").forEach(t=>{t.dataset.bittyid=a()})}}customElements.define(e,s);