const t=[6,0,0],e=`bitty-${t[0]}-${t[1]}`;class n extends Error{constructor(t){super(),Error.captureStackTrace&&Error.captureStackTrace(this,n),this.name="BittyError";for(let[e,n]of Object.entries(t))this[e]=n}}class i extends Event{constructor(){super("bittybittyinit",{bubbles:!0})}}class s extends Event{constructor(){super("bittybittyready",{bubbles:!0})}}class r extends Event{constructor(t,e){super("bittydatainit",{bubbles:!0}),this.signal=t,this.el=e}}class a extends Event{constructor(t,e){super("bittyforward",{bubbles:!0}),this.forwardedEvent=t,this.forwardedSignal=e}}class o extends Event{constructor(t){super("bittylocaltrigger",{bubbles:!0}),this.signal=t}}class c extends Event{constructor(t){super("bittytrigger",{bubbles:!0}),this.signal=t}}function l(t,e){return void 0!==t.dataset[e]?t.dataset[e]:t.parentNode?l(t.parentNode,e):null}class d extends HTMLElement{constructor(){super(),this.config={listeners:["click","input"],license:"CC0",version:t}}async connectedCallback(){this.dataset.bittyid=self.crypto.randomUUID(),this.style.display="block",await this.makeConnection(),this.conn&&(this.conn.api=this,this.handleEventBridge=this.handleEvent.bind(this),this.setIds(this),this.addEventListeners(),await this.runBittyInit(),this.runDataInits(),await this.runBittyReady())}addEventListeners(){const t=["bittybittyinit","bittybittyready","bittydatainit","bittyforward","bittylocaltrigger","bittytrigger"];this.dataset.listeners?this.trimInput(this.dataset.listeners).forEach(e=>{t.push(e)}):(t.push("click"),t.push("input")),t.forEach(t=>{window.addEventListener(t,t=>{this.handleEventBridge.call(this,t)})})}connectedMoveCallback(){}doSubs(t,e){return e.forEach(e=>{const n=typeof e[1],i=Object.prototype.toString.call(e[1]);if("object"===n&&"[object Array]"===i){const n=e[1].map(t=>{const e=typeof t,n=Object.prototype.toString.call(t);return"object"===e&&"[object DocumentFragment]"===n?[...t.childNodes].map(t=>"[object Text]"===Object.prototype.toString.call(t)?t.wholeText:t.outerHTML).join(""):"object"===e?t.outerHTML:t}).join("");t=t.replaceAll(e[0],n)}else if("object"===n&&"[object DocumentFragment]"===i){const n=[];[...e[1].childNodes].forEach(t=>{"[object Text]"===Object.prototype.toString.call(t)?n.push(t.wholeText):n.push(t.outerHTML)}),t=t.replaceAll(e[0],n.join(""))}else t="object"==typeof e[1]?t.replaceAll(e[0],e[1].outerHTML):t.replaceAll(e[0],e[1])}),t}forward(t,e){const n=new a(t,e);this.dispatchEvent(n)}getBittyParent(t){return t.localName.toLowerCase()===e?t:t.parentNode?this.getBittyParent(t.parentNode):null}async getElement(t,e=[],n={}){const i=await this.getHTML(t,e,n,"getElement");if(i.value){return{value:i.value.firstChild}}return i}async getHTML(t,e=[],n={}){const i=await this.getTXT(t,e,n,"getHTML");return i.error?i:{value:this.makeHTML(i.value,e)}}async getJSON(t,e=[],i={}){const s=await this.getTXT(t,e,i,"getJSON");if(s.error)return s;try{const t=JSON.parse(s.value);return{value:t}}catch(t){return{error:new n({type:"parsing"})}}}async getSVG(t,e=[],n={}){const i=await this.getTXT(t,e,n,"getSVG");if(i.error)return i;{const t=document.createElement("template");t.innerHTML=i.value;return{value:t.content.cloneNode(!0).querySelector("svg")}}}async getTXT(t,e=[],i={},s="getTXT"){let r=await fetch(t,i);try{if(r.ok){return{value:this.doSubs(await r.text(),e)}}throw new n({type:"fetching",message:`${s}() returned ${r.status} [${r.statusText}] in:\n${s}(${r.url}, ${JSON.stringify(e)}, ${JSON.stringify(i)})`,statusText:r.statusText,status:r.status,url:r.url,incomingMethod:s,subs:e,options:i})}catch(t){return console.error(`BittyError: ${t.message}`),{error:t}}}findSender(t,e){e.dataset&&e.dataset.send?t.sender=e:e.parentNode&&this.findSender(t,e.parentNode)}async handleEvent(t){if("bittybittyinit"===t.type)this.dataset.bittyid===t.target.dataset.bittyid&&"function"==typeof this.conn.bittyInit&&("AsyncFunction"===this.conn.bittyInit[Symbol.toStringTag]?await this.conn.bittyInit():this.conn.bittyInit());else if("bittybittyready"===t.type)this.dataset.bittyid===t.target.dataset.bittyid&&"function"==typeof this.conn.bittyReady&&("AsyncFunction"===this.conn.bittyReady[Symbol.toStringTag]?await this.conn.bittyReady():this.conn.bittyReady());else if("bittylocaltrigger"===t.type){t.sender=t.target;const e=this.trimInput(t.signal),n=this.querySelectorAll("[data-receive]");for(let i of e){let e=!1;const s=i.split(":");if(2===s.length&&"await"===s[0]&&(e=!0,i=s[1]),this.conn[i]){const s=this.getBittyParent(t.target);let r=!1;for(let a of n){const n=this.getBittyParent(a);if(s.dataset.bittyid===n.dataset.bittyid){const n=this.trimInput(a.dataset.receive);for(let s of n){const n=s.split(":");2===n.length&&"await"===n[0]&&(e=!0,s=n[1]),s===i&&(r=!0,this.prepElements(t,a),e?await this.conn[i](t,a):this.conn[i](t,a))}}}!1===r&&s.dataset.bittyid===this.dataset.bittyid&&(e?await this.conn[i](t,null):this.conn[i](t,null))}}}else if("bittytrigger"===t.type){t.sender=t.target;const e=this.trimInput(t.signal),n=this.querySelectorAll("[data-receive]");for(let i of e){let e=!1;const s=i.split(":");if(2===s.length&&"await"===s[0]&&(e=!0,i=s[1]),this.conn[i]){let s=!1;for(let r of n){const n=this.trimInput(r.dataset.receive);for(let a of n){const n=a.split(":");2===n.length&&"await"===n[0]&&(e=!0,a=n[1]),a===i&&(s=!0,this.prepElements(t,r),e?await this.conn[i](t,r):this.conn[i](t,r))}}!1===s&&(e?await this.conn[i](t,null):this.conn[i](t,null))}}}else if("bittydatainit"===t.type){if(t.sender=t.target,this.prepElements(t,t.el),this.dataset.bittyid===t.el.bittyParentId){const e=this.trimInput(t.signal);for(const n of e)this.conn[n]&&this.conn[n](t,t.el)}}else if("bittyforward"===t.type){const e=this.trimInput(t.forwardedSignal);t=t.forwardedEvent;const n=this.querySelectorAll("[data-receive]");for(let i of n){this.prepElements(t,i);const n=this.trimInput(i.dataset.receive);for(let s of n)e.includes(s)&&this.conn[s]&&this.conn[s](t,i)}}else if(this.findSender(t,t.target),t.sender){const e=this.trimInput(t.sender.dataset.send),n=this.querySelectorAll("[data-receive]");for(let i of e){let e=!1;const s=i.split(":");if(2===s.length&&"await"===s[0]&&(e=!0,i=s[1]),this.conn[i]){let s=!1;for(let r of n){const n=this.trimInput(r.dataset.receive);for(const a of n){const n=a.split(":");2===n.length&&"await"===n[0]&&(a=n[1]),a===i&&(s=!0,this.prepElements(t,r),e?await this.conn[i](t,r):this.conn[i](t,r))}}!1===s&&(e?await this.conn[i](t,null):this.conn[i](t,null))}}}}localTrigger(t){const e=new o(t);this.dispatchEvent(e)}async loadCSS(t,e,n){const i=await this.getTXT(t,e,n,"loadCSS");if(i.error)return i;{const t=new CSSStyleSheet;return t.replaceSync(i.value),document.adoptedStyleSheets.push(t),{value:i.value}}}async makeConnection(){try{if(this.dataset.connect){let t=this.trimInput(this.dataset.connect);if(void 0!==window[t[0]])this.conn=new window[t[0]];else{if("/"===t[0].substring(0,1)){const e=new URL(window.location.href);t[0]=new URL(t[0],e.origin).toString()}if("http"===t[0].substring(0,4)){const e=await import(t[0]);void 0===t[1]?this.conn=new e.default:this.conn=new e[t[1]]}else console.error("The value of 'data-connect' must start with 'http' or '/'. Other URLs are not currently supported")}}else window.BittyClass?this.conn=new window.BittyClass:console.error(`${e} error: No class to connect to.`)}catch(t){console.error(`${e} error: ${t} - ${this.dataset.connect}`)}}makeElement(t,e=[]){return this.makeHTML(t,e).firstChild}makeHTML(t,e=[]){const n=document.createElement("template");n.innerHTML=this.makeTXT(t,e).trim();const i=n.content.cloneNode(!0);return this.setIds(i),i}makeTXT(t,e=[]){return this.doSubs(t,e)}prepElements(t,e){e.isTarget=t.target.dataset.bittyid===e.dataset.bittyid,e.isSender=t.sender.dataset.bittyid===e.dataset.bittyid,e.bittyParent=this.getBittyParent(e),e.bittyParentId=e.bittyParent.dataset.bittyid,e.bittyId=e.dataset.bittyid,e.getString=t=>l.call(null,e,t),e.getInt=t=>parseInt(l.call(null,e,t)),e.getFloat=t=>parseFloat(l.call(null,e,t))}async runBittyInit(){if("function"==typeof this.conn.bittyInit){const t=new i;this.dispatchEvent(t)}}async runBittyReady(){if("function"==typeof this.conn.bittyReady){const t=new s;this.dispatchEvent(t)}}runDataInits(){if(this.dataset.init){const t=new r(this.dataset.init,this);this.dispatchEvent(t)}else this.querySelectorAll("[data-init]").forEach(t=>{const e=new r(t.dataset.init,t);this.dispatchEvent(e)})}setProp(t,e){document.documentElement.style.setProperty(t,e)}setIds(t){t.querySelectorAll("*").forEach(t=>{t.dataset.bittyid||(t.dataset.bittyid=self.crypto.randomUUID())})}trigger(t){const e=new c(t);this.dispatchEvent(e)}trimInput(t){return t.trim().split(/\s+/m).map(t=>t.trim())}}customElements.define(e,d);