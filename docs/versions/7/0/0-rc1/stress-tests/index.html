<!DOCTYPE html>
<html lang="en">
  <head>
<style>
body {
background-color: black;
color: goldenrod;
}
    </style>
  </head>
  <body>
<script>
function sleep(ms) {
  return new Promise((resolve) => setTimeout(resolve, ms));
}

const templates = {
  reportItem: `<div>
  <h4>TITLE</h4>
  <div>DESCRIPTION</div>
  <div>Duration: DURATION</div>
</div>`,
};

const tests = {
  test0010: {
    description:
      `Make 1000 elements with this.api.makeElement('<span>x </span>') and append them one at a time with .appendChild()`,
    prep: `<div data-receive="test0010run">
<button data-send="test0010send">Test Trigger</button>
<div data-receive="test0010send"></div>
</div>`,
    template: `<span>x </span>`,
  },

  test0020: {
    description:
      `Make 1000 elements in one go with this.api.makeHTML(TEMPLATE) and append them all at the same time with .appendChild()`,
    prep: `<div data-receive="test0020run">
<button data-send="test0020send">Test Trigger</button>
<div data-receive="test0020send"></div>
</div>`,
  },

  test0030: {
    description: `{"extension": "html", "file_move_type": "Transform", "folder": "versions/7/0/0-rc1/stress-tests", "folder_parts": ["versions", "7", "0", "0-rc1", "stress-tests"], "input_path": "versions/7/0/0-rc1/stress-tests/index.html", "name": "index.html", "output_folder": "versions/7/0/0-rc1/stress-tests", "output_name": "index.html", "parent_folder": "stress-tests", "stem": "index"} - One top level bitty element `,
    prep: `<bitty-7-0>

</bitty-7-0>
`,
  },
};

class Report {
  constructor(id, data) {
    this.id = id;
    this.data = data;
  }
}

window.TestRunner = class {
  #currentTestIndex = -1;
  #reports = [];

  async bittyReady() {
    this.api.trigger("runTest");
  }

  async runTest(_, el) {
    await sleep(400);
    this.#currentTestIndex += 1;
    if (Object.keys(tests).length === this.#currentTestIndex) {
      el.innerHTML = "this is the report";
      for (const key of Object.keys(tests)) {
        performance.measure(
          `${key}-duration`,
          `${key}-start`,
          `${key}-end`,
        );
        const entry = performance.getEntriesByName(`${key}-duration`);
        const subs = [
          ["TITLE", key],
          ["DESCRIPTION", tests[key].description],
          ["DURATION", Math.round(entry[0].duration)],
        ];
        el.appendChild(this.api.makeHTML(templates.reportItem, subs));
      }
    } else {
      const currentTest = Object.keys(tests)[this.#currentTestIndex];
      el.replaceChildren(this.api.makeElement(
        tests[currentTest].prep,
      ));
      this.api.trigger(
        `${currentTest}prep`,
      );
    }
  }

  markStart() {
    const currentTest = Object.keys(tests)[this.#currentTestIndex];
    performance.mark(`${currentTest}-start`);
  }

  markEnd() {
    const currentTest = Object.keys(tests)[this.#currentTestIndex];
    performance.mark(`${currentTest}-end`);
  }

  test0010prep(_, el) {
    this.api.trigger("test0010run");
  }

  test0010run(_, el) {
    this.markStart();
    el.querySelector("button").click();
  }

  test0010send(_, el) {
    [...Array(1000)].forEach((_, index) => {
      el.appendChild(this.api.makeElement(tests.test0010.template));
    });
    this.markEnd();
    this.api.trigger("runTest");
  }

  test0020prep(_, el) {
    this.api.trigger("test0020run");
  }

  test0020run(_, el) {
    el.querySelector("button").click();
  }

  test0020send(_, el) {
    const template = [`<div>`];
    [...Array(1000)].forEach((_, index) => {
      template.push(`<span>x </span>`);
    });
    template.push(`</div>`);
    const incoming = template.join("");
    this.markStart();
    el.replaceChildren(this.api.makeHTML(incoming));
    this.markEnd();
    this.api.trigger("runTest");
  }

  test0030prep(_, el) {
    console.log(tests["test0030"].prep);
    this.api.trigger("test0030run");
  }

  test0030run(_, el) {
    this.markStart();
    this.markEnd();
    this.api.trigger("runTest");
  }

  //
};

window.test0010 = class {
};

window.test0020 = class {
};

window.test0030 = class {
};</script>

<h1>Stress Test 0010</h1>

<bitty-7-0 data-connect="TestRunner">
<div data-receive="runTest"></div>
</bitty-7-0>

<div class="testArea"></div>

    <script src="&#x2f;v&#x2f;7.0.0-rc1&#x2f;bitty-7.0.0-rc1.full.js" type="module"></script>
  </body>
</html>